---
title: "07-test-LM-region-differences"
author: "Ariel Marcy"
date: "10/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
#par(mfrow=c(1,1))
```

# Test variation within morphospace
What is causing high levels of allometry? Is it functional integration of the gnawing apparatus (mostly in the top cranium-rostrum area)? 

If so, we would expect to see the top cranium-rostrum to be the least variable across species compared to the basicranium-top cranium and basicranium-rostrum comparisons. 

### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(png)  # needed to work with screenshots
library(colorspace)  # plot colors
# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
library(data.table)
library(vegan)
library(geomorph)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/05-residual-data.rda")
```

## Choose the partitions
The three partitions will need to be designated from the LM numbers. The first time, this was done with `define.modules()` but each module was then saved in a .csv file so this step can be repeated much more quickly.

### Load in the partitions for all subsequent times
```{r}
lm.modules <- read.csv("../Data/Processed/Landmark_modules.csv", sep = ",", header = TRUE)
```

### Visualize the landmark types
```{r}
# Deconstruct function from Thomas's code in Landmark-test
ref <- mshape(shape)  
PartLevels <- unique(lm.modules[, 5])
Colors <- rainbow(length(PartLevels))
Colors <- c("blue", "gray", "black")  # semi, patch, fixed

# Subset the landmarks according to the partitions
Part <- list()
for(i in 1:length(PartLevels)){
        Part[[i]] <- which(lm.modules[, 5] == PartLevels[[i]])
}

# 3D plot of the partitions
open3d()
for (i in 1:length(PartLevels)){
        spheres3d(ref[Part[[i]], 1], ref[Part[[i]], 2], ref[Part[[i]], 3], col = Colors[i], lit = TRUE, radius = 0.001, asp = FALSE)
}
```

### Visualize the 3 partitions
```{r}
# Deconstruct function from Thomas's code in Landmark-test
ref <- mshape(shape)  
PartLevels <- unique(lm.modules[, 3])
Colors <- rainbow(length(PartLevels))
Colors <- c("brown", "gray",  "#79ABE2")  

# Subset the landmarks according to the partitions
Part <- list()
for(i in 1:length(PartLevels)){
        Part[[i]] <- which(lm.modules[, 3] == PartLevels[[i]])
}

# 3D plot of the partitions
open3d()
for (i in 1:length(PartLevels)){
        spheres3d(ref[Part[[i]], 1], ref[Part[[i]], 2], ref[Part[[i]], 3], col = Colors[i], lit = TRUE, radius = 0.001, asp = FALSE)
}
```

## Test modularity with 3 partitions
```{r}
# Rostrum versus top cranium and basicranium
mod.test.1 <- modularity.test(shape, partition.gp = (lm.modules[, 3]))
mod.test.1$CR.mat  # results

# And now a test with the phylogentic tree (and mean shapes)
mod.test.phy <- phylo.modularity(mean.shapes, partition.gp = lm.modules[, 3], aus.tree)
```

### Visualize the 6 partitions from Goswami 2006/7
```{r}
# Deconstruct function from Thomas's code in Landmark-test
PartLevels <- unique(lm.modules[, 4])  # 5 modules from Goswami's 6 (missing zygomatic)
Colors <- rainbow(length(PartLevels))

# Subset the landmarks according to the partitions
Part <- list()
for(i in 1:length(PartLevels)){
  Part[[i]] <- which(lm.modules[, 4] == PartLevels[[i]])
}

# 3D plot of the partitions
open3d()
for (i in 1:length(PartLevels)){
  spheres3d(ref[Part[[i]], 1], ref[Part[[i]], 2], ref[Part[[i]], 3], col = Colors[i], lit = TRUE, radius = 0.001, asp = FALSE)
  rgl.texts(ref[Part[[i]], 1], ref[Part[[i]], 2], ref[Part[[i]], 3], lm.modules[, 1], offset = 100, color = c("black"))
}
```

## Test modularity with 5 partitions
This test uses covariance ratio (CR) coefficients (Adams 2016) to quantify the degree of modularity between hypothesized modules/partitions. The observed CR is compared to the distribution found by randomizing the landmarks into partitions of identical sample sizes.

A significant modular signal: when the observed CR coefficient is significantly lower than the distribution of the randomized CR coefficients
```{r}
# Rostrum versus top cranium and basicranium
mod.test.5 <- modularity.test(shape, partition.gp = (lm.modules[, 4]))

# Make pairwise comparison table
mod.result <- as.matrix(mod.test.5$CR.mat)  # results
colnames(mod.result) <- c("vault", "orbital", "basicran", "rostrum", "molar")
rownames(mod.result) <- c("vault", "orbital", "basicran", "rostrum", "molar")

plot(mod.test.5)

# And now with the phylogentic tree (and mean shapes)
mod.test.5.phy <- phylo.modularity(mean.shapes, partition.gp = lm.modules[, 4], aus.tree)

# Make pairwise comparison table
mod.result.phy <- as.matrix(mod.test.5.phy$CR.mat)  # results
colnames(mod.result.phy) <- c("vault", "orbital", "basicran", "rostrum", "molar")
rownames(mod.result.phy) <- c("vault", "orbital", "basicran", "rostrum", "molar")

plot(mod.test.5.phy)

# Test without hydromys
shape.noHyd <- shape[, , -which(dimnames(shape)[[3]] == "Hydromys_chrysogaster")]
mod.test.5.noHyd <- modularity.test(shape.noHyd, partition.gp = (lm.modules[, 4]))
plot(mod.test.5.noHyd)
# barely a difference is made
```

### Test if modularity signal is different across clades
```{r}
coords.clade <- coords.subset(mean.shapes, info.means$Clade)

# Remove single-species clades
clade.index <- 1:nlevels(info.means$Clade)[-c(4,5)]  # removes Mus and Pogonomys

# Use lapply function to perform modularity test on 3D arrays in each clade
mod.clade.tests <- lapply(clade.index, function(j) modularity.test(coords.clade[[j]], partition.gp = lm.modules[, 4], iter = 500, print.progress = FALSE))

# Apply function from 2019 Adams & Collyer paper
clade.CRs <- compare.CR(mod.clade.tests, CR.null = FALSE)
clade.CRs
```

### Test if modularity signal is different across tribes
```{r}
coords.tribe <- coords.subset(mean.shapes, info.means$Endemic)

# Use lapply function to perform modularity test on 3D arrays in each tribe
mod.tribe.tests <- lapply(c(2,3), function(j) modularity.test(coords.tribe[[j]], partition.gp = lm.modules[, 4], iter = 500, print.progress = TRUE))

# Apply function from 2019 Adams & Collyer paper
tribe.CRs <- compare.CR(mod.tribe.tests, CR.null = FALSE)
tribe.CRs
```

## Integration test
```{r}
int.test <- integration.test(mean.shapes, partition.gp = lm.modules[, 4], iter = 500)

```

## Double check with Two-Block Least Squared analysis
```{r}
# Define coords that refer to modules
rostrum <- which(lm.modules[, 3] == "rostrum")  
top.cran <- which(lm.modules[, 3] == "topcran") 
basicran <- which(lm.modules[, 3] == "basicran")

# Do pairwise comparisons between each of the modules
rost.v.tcran <- two.b.pls(shape[rostrum, , ], shape[top.cran, ,])
rost.v.basi <- two.b.pls(shape[rostrum, , ], shape[basicran, ,])
tcran.v.basi <- two.b.pls(shape[top.cran, , ], shape[basicran, ,])

# See results
summary(rost.v.tcran)
summary(rost.v.basi)
summary(tcran.v.basi)
```

### Two-Block Least Squared analysis on old vs new endemics
```{r}
# Subset shape 
non.old.end <- which(info$Clade == "Rattini" | info$Clade == "invRattini" | info$Clade == "Mus")

end.shape <- shape[, , -non.old.end]  # only old endemics (n = 233)

# Do pairwise comparisons between each of the modules
rost.v.tcran <- two.b.pls(end.shape[rostrum, , ], end.shape[top.cran, ,])
rost.v.basi <- two.b.pls(end.shape[rostrum, , ], end.shape[basicran, ,])
tcran.v.basi <- two.b.pls(end.shape[top.cran, , ], end.shape[basicran, ,])

# See results
summary(rost.v.tcran)
summary(rost.v.basi)
summary(tcran.v.basi)

# Do on new endemics
end.shape <- shape[, , non.old.end]  # only new endemics (n = 83)

# Do pairwise comparisons between each of the modules
rost.v.tcran <- two.b.pls(end.shape[rostrum, , ], end.shape[top.cran, ,])
rost.v.basi <- two.b.pls(end.shape[rostrum, , ], end.shape[basicran, ,])
tcran.v.basi <- two.b.pls(end.shape[top.cran, , ], end.shape[basicran, ,])

# See results
summary(rost.v.tcran)
summary(rost.v.basi)
summary(tcran.v.basi)
```

## Triple check with compare evolutionary rates of traits within the crania
```{r}
cme.rates <- compare.multi.evol.rates(mean.shapes, gp = as.character(lm.modules[, 4]), aus.tree)
 
summary(cme.rates)  # results
cme.rates$pairwise.pvalue  
```