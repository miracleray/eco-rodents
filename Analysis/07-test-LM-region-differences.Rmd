---
title: "07-test-LM-region-differences"
author: "Ariel Marcy"
date: "10/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Test variation within morphospace
What is causing high levels of allometry? Is it functional integration of the gnawing apparatus (mostly in the top cranium-rostrum area), for example? 

1) Tests modularity adjusting for phylogenetic signal using CR metrics

2) Tests modularity with Mantel tests of PC scores from each module

3) Tests for global integration

Makes Figure 4, Table 1, and Supplementary Figure TK

### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(png)  # needed to work with screenshots
library(colorspace)  # plot colors
library(wesanderson)
# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
library(data.table)
library(vegan)
library(geomorph)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/05-residual-data.rda")
# Can load in time consuming modularity test after first run:
load(file = "../Data/Processed/07-modularity.rda")
```

## Choose the partitions
The three partitions will need to be designated from the LM numbers. The first time, this was done with `define.modules()` but each module was then saved in a .csv file so this step can be repeated much more quickly.

### Load in the partition definitions
```{r}
lm.modules <- read.csv("../Data/Processed/Landmark_modules.csv", sep = ",", header = TRUE)
```

### Visualize the landmark types
```{r}
# Deconstruct function from Thomas's code in Landmark-test
ref <- mshape(shape)  
lm.levels <- unique(lm.modules[, 5])
lm.colors <- c("blue", "gray", "black")  # semi, patch, fixed

# Subset the landmarks according to the partitions
lm.parts <- list()
for(i in 1:length(lm.levels)){
        lm.parts[[i]] <- which(lm.modules[, 5] == lm.levels[[i]])
}

# 3D plot of the partitions
open3d()
for (i in 1:length(lm.levels)){
        spheres3d(ref[lm.parts[[i]], 1], ref[lm.parts[[i]], 2], ref[lm.parts[[i]], 3], col = lm.colors[i], lit = TRUE, radius = 0.001, asp = FALSE)
}
```

### Visualize the partitions from Goswami 2006/7
6 partitions hypothesized for mammals, our dataset supports 5 (missing zygomatic)
```{r}
# Deconstruct function from Thomas's code in Landmark-test
ref <- mshape(shape)
mod.levels<- sort(unique(lm.modules[, 4]))  # 5 (of 6) modules from Goswami

# Define nice colors for modules
mod.colors <- c(wes_palette("GrandBudapest1")[2:4], wes_palette("GrandBudapest2")[1:2])

# Subset the landmarks according to the partitions
mod.parts <- list()
for(i in 1:length(mod.levels)){
  mod.parts[[i]] <- which(lm.modules[, 4] == mod.levels[[i]])
}

# 3D plot of the partitions
open3d(windowRect = c(0, 0, 600, 600))
for(i in 1:length(mod.levels)) {
        spheres3d(ref[mod.parts[[i]], 1], ref[mod.parts[[i]], 2], ref[mod.parts[[i]], 3], col = mod.colors[i], lit = TRUE, radius = 0.0015, asp = FALSE)
        #rgl.texts(ref[mod.parts[[i]], 1], ref[mod.parts[[i]], 2], ref[mod.parts[[i]], 3], mod.parts[[i]], offset = 100, color = c("black"))
}
view3d(phi = 90) # Lateral view, right side up
rgl.snapshot("../Data/Processed/modules.png")

# Remove whitespace from new image (requires ImageMagik installed on PC)
system("mogrify ../Data/Processed/modules.png -trim ../Data/Processed/*.png")

# Load png back in
module.plot <- readPNG("../Data/Processed/modules.png")
```

## Test modularity with 5 partitions
This test uses covariance ratio (CR) coefficients (Adams 2016) to quantify the degree of modularity between hypothesized modules/partitions. The observed CR is compared to the distribution found by randomizing the landmarks into partitions of identical sample sizes.

A significant modular signal: when the observed CR coefficient is significantly lower than the distribution of the randomized CR coefficients
```{r}
# Test with the phylogentic tree (and mean shapes)
mod.test.5.phy <- phylo.modularity(mean.shapes, partition.gp = lm.modules[, 4], aus.tree)

# Make pairwise comparison table
mod.result.phy <- as.matrix(mod.test.5.phy$CR.mat)  # results
colnames(mod.result.phy) <- c("vault", "orbital", "basicran", "rostrum", "molar")
rownames(mod.result.phy) <- c("vault", "orbital", "basicran", "rostrum", "molar")

save(mod.test.5.phy, mod.result.phy, file = "../Data/Processed/07-modularity.rda")
```

## Make Figure 4
```{r}
# Set up multipanel figure
mat <- matrix(c(1, 2), 2, 1, byrow = TRUE) # 2 plots, 1 row, 2 columns
layout(mat, widths = rep.int(1, ncol(mat)), heights = rep.int(1, nrow(mat)))  

# 1) Plot of modules
par(mar = c(1, 1, 1, 1))  # sets the margins
plot(c(0, dim(module.plot)[2]), c(0, dim(module.plot)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = TRUE) 
rasterImage(module.plot, 0, 0, dim(module.plot)[2], dim(module.plot)[1])
legend("topleft", "A", cex = 2, bty = "n", inset = -0.09)
text(70, -13, "Basicranium", cex = 0.9, bty = "n", col = mod.colors[1])
text(255, 15, "Molar", cex = 0.9, bty = "n", col = mod.colors[2])
text(249, 182, "Orbital", cex = 0.9, bty = "n", col = mod.colors[3])
text(415, 140, "Rostrum", cex = 0.9, bty = "n", col = mod.colors[4])
text(40, 175, "Vault", cex = 0.9, bty = "n", col = wes_palette("GrandBudapest2")[4])  # similar but darker color
```

```{r}
# 2) Plot of CR ratios (with phylogenetic correction)
par(mar = c(3.5, 3.5, 0, 0))  # margins; need space left & bottom for labels
hist(mod.test.5.phy$random.CR,
     main = NULL,
     xlab = "",
     xlim = c(0.9, 1.1),
     ylab = "",
     cex.axis = 0.9,
     col = "black")
title(xlab = "Covariance ratio (CR) coefficient", line = 2.4)
title(ylab = "Frequency of resampled CR", line = 2.45)
arrows(x0 = mod.test.5.phy$CR, y0 = 200, y1 = 8, length = 0.15, lwd = 1.5, col = "darkred")
text(mod.test.5.phy$CR - 0.005, 225, "Observed CR", cex = 0.9, col = "darkred")
legend("topleft", "B", cex = 2, bty = "n", inset = c(-0.1, -0.05))
text(0.945, 400, "resampled CR coefficients", cex = 0.9, bty = "n")
```

## Mantel Test to see if PCs of modules are equivalent
Uses method by Dr Emma Sherratt
```{r}
# Separate modules - using 5-module framework 
mod.1 <- mean.shapes[which(lm.modules[, 4] == "basicran"), ,]
mod.2 <- mean.shapes[which(lm.modules[, 4] == "molar"), ,]
mod.3 <- mean.shapes[which(lm.modules[, 4] == "orbital"), ,]
mod.4 <- mean.shapes[which(lm.modules[, 4] == "rostrum"), ,]
mod.5 <- mean.shapes[which(lm.modules[, 4] == "vault"), ,]

# Run PCAs
PCA.1 <- plotTangentSpace(mod.1)
PCA.2 <- plotTangentSpace(mod.2)
PCA.3 <- plotTangentSpace(mod.3)
PCA.4 <- plotTangentSpace(mod.4)
PCA.5 <- plotTangentSpace(mod.5)

# Make distance matrices
d.PCA.1 <- dist(PCA.1$pc.scores)
d.PCA.2 <- dist(PCA.2$pc.scores)
d.PCA.3 <- dist(PCA.3$pc.scores)
d.PCA.4 <- dist(PCA.4$pc.scores)
d.PCA.5 <- dist(PCA.5$pc.scores)

# Run Mantel tests
m.1v2 <- mantel(d.PCA.1, d.PCA.2, method = "pearson", permutations = 1000) 
m.1v3 <- mantel(d.PCA.1, d.PCA.3, method = "pearson", permutations = 1000)
m.1v4 <- mantel(d.PCA.1, d.PCA.4, method = "pearson", permutations = 1000)
m.1v5 <- mantel(d.PCA.1, d.PCA.5, method = "pearson", permutations = 1000)

m.2v3 <- mantel(d.PCA.2, d.PCA.3, method = "pearson", permutations = 1000) 
m.2v4 <- mantel(d.PCA.2, d.PCA.4, method = "pearson", permutations = 1000)
m.2v5 <- mantel(d.PCA.2, d.PCA.5, method = "pearson", permutations = 1000)

m.3v4 <- mantel(d.PCA.3, d.PCA.4, method = "pearson", permutations = 1000)
m.3v5 <- mantel(d.PCA.3, d.PCA.5, method = "pearson", permutations = 1000)

m.4v5 <- mantel(d.PCA.4, d.PCA.5, method = "pearson", permutations = 1000)

# Bonferroni correction
p.vals.bon <- round(p.adjust(c(m.1v2$signif, m.1v3$signif, m.1v4$signif, m.1v5$signif, m.2v3$signif, m.2v4$signif, m.2v5$signif, m.3v4$signif, m.3v5$signif, m.4v5$signif), method = "bonferroni"), 3)

# Make results table
col1 <- c("-", p.vals.bon[1], p.vals.bon[2], p.vals.bon[3], p.vals.bon[4])
col2 <- c(m.1v2$statistic, "-", p.vals.bon[5], p.vals.bon[6], p.vals.bon[7])
col3 <- c(m.1v3$statistic, m.2v3$statistic, "-", p.vals.bon[8], p.vals.bon[9])
col4 <- c(m.1v4$statistic, m.2v4$statistic, m.3v4$statistic, "-", p.vals.bon[10])
col5 <- c(m.1v5$statistic, m.2v5$statistic, m.3v5$statistic, m.4v5$statistic, "-")

modules <- sort(unique(as.factor(lm.modules[, 4])))
mantel.results <- data.table(basicran = col1, molar = col2, orbital = col3, rostrum = col4, vault = col5, row.names = modules)

# Export Table S6
write.table(mantel.results, "../Data/Results/Table_MantelTests.csv", sep = ",", col.names = NA)
```

### Whole integration test - supplementary Figure TK
Test whether rodent skull is integrated as a whole
```{r}
globalIntegration(mean.shapes)
```