---
title: "07-test-LM-region-differences"
author: "Ariel Marcy"
date: "10/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
#par(mfrow=c(1,1))
```

# Test variation within morphospace
What is causing high levels of allometry? Is it functional integration of the gnawing apparatus (mostly in the top cranium-rostrum area)? 

If so, we would expect to see the top cranium-rostrum to be the least variable across species compared to the basicranium-top cranium and basicranium-rostrum comparisons. 

### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(png)  # needed to work with screenshots
library(colorspace)  # plot colors
# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
library(data.table)
library(vegan)
library(geomorph)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-sm-PCA-with-color.rda")
load(file = "../Data/Processed/allometry_rodents_04-phylo-data.rda")  # phylogenetic tree from Allometry Rodents paper / repo
```

## Choose the partitions
The three partitions will need to be designated from the LM numbers. The first time, this was done with `define.modules()` but each module was then saved in a .csv file so this step can be repeated much more quickly. 

### Choose the partitions for the first time
```{r}
modules <- define.modules(shape[, , 1], nmodules = 3)  # see numbers on skull
write.table(pt.names, "../Data/Processed/Landmark_names.csv", sep = ",", col.names = NA)  # exports landmark names and numbers
```

### Load in the partitions for all subsequent times
```{r}
lm.modules <- read.csv("../Data/Processed/Landmark_modules.csv", sep = ",", header = TRUE)
```

### Visualize the partitions
```{r}
# Deconstruct function from Thomas's code in Landmark-test
lm.modules[, 3]
ref <- mshape(shape)  
PartLevels <- unique(lm.modules[, 3])
Colors <- rainbow(length(PartLevels))
Colors <- c("pink", "gray", "brown")  # Pink gallah
Colors <- c("hot pink", "violet", "purple") # Vera's request :P

# subset the landmarks according to the partitions
Part <- list()
for(i in 1:length(PartLevels)){
        Part[[i]] <- which(lm.modules[, 3] == PartLevels[[i]])
  }

# 3D plot of the partitions
open3d()
for (i in 1:length(PartLevels)){
        spheres3d(ref[Part[[i]], 1], ref[Part[[i]], 2], ref[Part[[i]], 3], col = Colors[i], lit = TRUE, radius = 0.001, asp = FALSE)
        }
```

## Test modularity
```{r}
# Rostrum versus top cranium and basicranium
mod.test.1 <- modularity.test(shape, partition.gp = (lm.modules[, 3]))
mod.test.1$CR.mat  # results

# And now a test with the phylogentic tree (and mean shapes)
mod.test.phy <- phylo.modularity(mean.shapes.tree, partition.gp = lm.modules[, 3], aus.tree)
```

## Double check with Two-Block Least Squared analysis
```
