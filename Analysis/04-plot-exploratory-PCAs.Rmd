---
title: "04-plot-exploratory-PCAs"
author: "Ariel Marcy"
date: "2018-10-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Plotting exploratory PCAs
PCAs provide a human-friendly way to visualize shape data. They are a good way to understand what's going on in the data quickly. However, because they artificially collapse the shape variation into orthogonal PC axes, they must be considered exploratory analyses only.

### Load packages, functions, and data
```{r message = FALSE}
library(stringr)
library(data.table)
library(geomorph)
library(colorspace)  # colors
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-sm-PCA-with-color.rda")
```

### Exploratory analyses with PCAs
Here, we explore the variation in rodent skulls by coloring the PCA plots by genus, by traits, by biome region.

Trait information was gathered from the book, Native Mice and Rats by Dr.s Bill Breed and Fred Ford (2007). 

Since we are going to add several columns to the metadata table, we'll remove columns no longer needed past the bilateral symmetry and replicate handling stages. 

```{r}
# Prep metadata for column additions
info <- info[, c(-4, -5, -7)]  # removes now-unnecessary columns

# Add trait data to the metadata table
traits <- read.csv("../Data/Processed/in_ex_traits.csv", header = TRUE)
traits$Taxa <- paste(str_sub(traits$Genus, 1, 1), str_sub(traits$Species, 1, 3), sep = "_")  # make matching Taxa column
info.traits <- merge(info, traits, by = "Taxa", sort = F)  # merge
info.traits <- info.traits[order(info.traits$Order), ]  # sort by Order

## Rename Genus and Species columns 
# short names (e.g. Pse or mus) have original column names
# long names (e.g. Pseudomys or musculus) have a ".y" appended
names(info.traits)[names(info.traits) == 'Genus.x'] <- 'Genus'
names(info.traits)[names(info.traits) == 'Species.x'] <- 'Species'

# Make full names column to compare to the phylogenetic tree
info.traits$FullName <- paste(info.traits$Genus.y, info.traits$Species.y, sep = "_")

# Make effective taxa column to assign Mastacomys to genus Pseudomys
info.traits$ETaxa <- info.traits$Taxa
info.traits$ETaxa[which(info.traits$Taxa == "M_fus")] <- "P_fus"
```

### Set up point types (matches allometry rodent key)
Pch #21 is default but different point types are assigned for genera with multiple species. 
```{r}
# legend in order of phylogeny, hard-coded to match allometry rodent paper; Z_ped added because this isn't tied to phylogeny
phylo.names <- c("M_mus", "R_rat", "R_nor", "R_lut", "R_leu", "R_tun", "R_vil", "R_sor", "R_fus", "P_mol", "X_myo", "H_chr", "N_cer", "N_fus", "N_mit", "N_ale", "P_pat", "P_gra", "P_ora", "P_sho", "P_des", "P_apo", "P_aus", "P_hig", "P_her", "P_nov", "P_del", "M_fus", "Z_arg", "Z_ped", "L_for", "U_cau", "M_cer", "M_cap", "M_bur", "L_con", "M_gou", "C_pen")

# pch vector with colors for legend (unique taxa) 
n.rat <- 8
n.not <- 4
n.pse <- 12
n.zyz <- 2
n.mel <- 3

phylo.cols <- c(col.phylo[1], rep.int(col.phylo[2], n.rat), col.phylo[3], col.phylo[4], col.phylo[5], rep.int(col.phylo[6], n.not), rep.int(col.phylo[7], n.pse), rep.int(col.phylo[8], n.zyz), col.phylo[9], col.phylo[10], rep.int(col.phylo[11], n.mel), col.phylo[12], col.phylo[13], col.phylo[14])

names(phylo.cols) <- phylo.names

# pch symbol vector with unique pch symbols for legend
pch.chain <- c(21, 22, 23, 24, 25, 7, 8, 9, 10, 11, 12, 13)
phylo.pch <- c(21, pch.chain[1:n.rat], 21, 21, 21, pch.chain[1:n.not], pch.chain[1:n.pse], pch.chain[1:n.zyz], 21, 21, pch.chain[1:n.mel], 21, 21, 21)
names(phylo.pch) <- phylo.names

# pch vector for all data
sp.pch.taxa <- phylo.pch[match(as.factor(info.traits$Taxa), names(phylo.pch))]
```

## Plot PCA by genus for small patch dataset
The function `PlotPCA()` quickly plots a PCA with specimens colored by groups and optionally given different point shapes for other attributes. The function also reports PC axis variation in %. 
```{r}
# Plot PCA by genus and export as .eps into ../Data/Results folder
### setEPS()
### postscript("../Data/Results/PCA_genus.eps")
PlotPCA(PCA, 1, 2, sp.col.gen, sp.pch.taxa)
legend("bottomright", legend = phylo.names, col = phylo.cols, pt.bg = phylo.cols, pch = phylo.pch, cex = .35, pt.cex = 1.5, ncol = 2)
### dev.off()
```

## PCA plot by diet and guild
This PCA colors specimens by diet and assigns point shape based on guild, i.e. where they spend most of their time.
```{r}
# Set up pallete for diet
warm <- sequential_hcl(5, "LaJolla")  
col.carn <- warm[4]  # meat colored red
col.frug <- warm[3]  # fruit colored orange
col.gran <- warm[2]  # grain colored gold
col.herb <- sequential_hcl(5, "Greens 3")[2]  # green colored grass
col.omni <- sequential_hcl(5, "Grays")[3]  # gray for anything goes

# Define color pallete for diets of all specimens
col.diet <- c(col.carn, col.frug, col.gran, col.herb, col.omni)
col.diet <- PlotByGroup(info.traits, "Feeding", col.diet)

# Points: Aquatic (circle), Arboreal (triangle), Terrestrial (square)
pch.gld <- c(19, 24, 22)
pch.gld <- PlotByGroup(info.traits, "Guild", pch.gld)
```

Plot PC1 vs PC2 and add custom legends.
```{r}
PlotPCA(PCA, 1, 2, col.diet, pch.gld)
legend("bottomright", legend = c("Aquatic", "Arboreal", "Terrest."), col = "black", border = NULL, pch = c(21, 24, 22))
text(-0.01, -0.09, "Carnivore", col = col.carn)
text(0.11, -0.02, "Frugivore", col = col.frug)
text(0.08, 0.045, "Herbivore", col = col.herb)
text(-0.07, -0.06, "Omnivore", col = col.omni)
text(-0.117, 0.01, "Granivore", col = col.gran)
```

## Morphospace partitioning by habitat
So far, most of the variation in the morphospace could be explained by size and genus affiliation, with different genera of similar sizes overlapping quite a bit. There doesn't seem to be much differentiation among Australian rodents, but perhaps the differentiation is hidden by geographical region or environmental partitioning. 

### Write functions to visualize rodent morphospace by region
Here, we subset the PCA scores by species which inhabit the 7 different ecological regions of Australia. Regions and species distributions therein taken from Breed & Ford 2007. `FoundInRegion()` subsets existing PCA data by species present in given region(s).

We'll use a loop to plot PCAs for each region, with unique species within each genera having a unique point shape. The legends only name the species present for a given region. 
```{r}
# Set up loop for particular regions in Australia
region.names <- c("Savannah", "Arid Zone", "NE Wet Forest", "NE Dry Forest", "Pilbara", "South West", "South East")
pc.scores <- subset(PCA$pc.scores, select = 1:3)  # only 1st 3 PCs

# Write x and y labels with proportion of variance for PCx and PCy
PCs <- PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1 (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2 (", PCy.per, "%)", sep = "")


par(mfrow=c(4,2), mar = c(2,2,2,2))
# Loop through all 7 regions to plot morphospace of species found in each
for (i in 1:7) {
        # Subset info.traits and PCA by region
        in.region <- FoundInRegion(info.traits, regions = i)
        info.region <- info.traits[in.region, ]
        pc.region <- as.data.frame(pc.scores[in.region, ])
        
        # Subset plotting colors and pch symbols for spp in region
        col.taxa.region <- sp.col.gen[in.region]  # colors for all spp
        pch.taxa.region <- sp.pch.taxa[in.region]  # pch for all spp
        
        # Subset legend by species present
        # uni.taxa <- unique(info.region$Taxa)
        # index <- which(phylo.names %in% uni.taxa)
        # legend.names <- phylo.names[index]
        # legend.col <- phylo.cols[index]
        # legend.pch <- phylo.pch[index]
        
        # Plot PCA with legend and labels
        PCA.plot <- plot(x = pc.region$PC1,
                         y = pc.region$PC2,
                         main = paste(region.names[i], "Region Morphospace" ),
                         xlab = PCx.lab,
                         ylab = PCy.lab,
                         xlim = c(-0.11, 0.18),
                         ylim = c(-0.095, 0.05),
                         col = col.taxa.region, 
                         pch = pch.taxa.region, 
                         bg = col.taxa.region,
                         cex = 1.5,
                         cex.axis = 1.3, 
                         cex.lab = 1.3)
        #legend("bottomright", legend = legend.names, col = legend.col, border = NULL, pch = legend.pch, pt.bg = legend.col, cex = 0.64, ncol = 2)
}
```

## Remove specialists from PCAs
This step is to see whether the PCA changes to highlight morphological differences among the less specialized species

### No aquatic carnivores
These are the most specialized so most likely to skew the visualization / hide variation in other areas of the PCA
```{r}
test.data <- info.traits[, c("Taxa", "Genus", "Species", "CatNum", "Order", "Csize", "Clade", "Feeding", "Guild")]  # relevant columns

# Subset out Hydromys and Xeromys
aquatic <- which(info.traits$Guild == "Aquatic")  # specimens to remove
test.data <- test.data[-aquatic, ]  # metadata
test.shape <- shape[, , -aquatic]  # shape data
test.col.gen <- sp.col.gen[-aquatic]  # color information
test.pch.gen <- sp.pch.taxa[-aquatic]  # point shape information

# Run PCA
no.aq.pca <- plotTangentSpace(test.shape, groups = test.col.gen, axis1 = 1, axis2 = 2, verbose = T)

# Plot PCA
PlotPCA(no.aq.pca, 1, 2, test.col.gen, test.pch.gen)
```

### Aquatic carnivores only
These are the most specialized so most likely to skew the visualization / hide variation in other areas of the PCA
```{r}
test.data <- info.traits[, c("Taxa", "Genus", "Species", "CatNum", "Order", "Csize", "Clade", "Feeding", "Guild")]  # relevant columns

# Subset out Hydromys and Xeromys
aquatic <- which(info.traits$Guild == "Aquatic" | info.traits$Feeding == "Frugivorous")  # specimens to remove
test.data <- test.data[-aquatic, ]  # metadata
test.shape <- shape[, , -aquatic]  # shape data
test.col.gen <- sp.col.gen[-aquatic]  # color information
test.pch.gen <- sp.pch.taxa[-aquatic]  # point shape information

# Run PCA
no.aq.pca <- plotTangentSpace(test.shape, groups = test.col.gen, axis1 = 1, axis2 = 2, verbose = T)

# Plot PCA
PlotPCA(no.aq.pca, 1, 2, test.col.gen, test.pch.gen)
```

### Save intermediate data
```{r}
save(traits, info.traits, phylo.names, phylo.cols, phylo.pch, sp.pch.taxa, col.diet, pch.gld, file = "../Data/Processed/04-sm-data-with-traits.rda")
```