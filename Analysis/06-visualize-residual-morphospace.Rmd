---
title: "06-visualize-residual-morphospace"
author: "Ariel Marcy"
date: "9/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Test biome partitioning 
1) Explore morphospace differences in PCA of size-less shape (residuals)

2) Assess patterns in skull shape variation along PC1 & 2 axes that could be related to adaptation

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)
library(data.table)
library(vegan)
library(geiger)  # for phylogenies
library(png)  # needed to work with screenshots
library(colorspace)  # plot colors

# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
source("../Functions/utilities.R")  # custom functions
source("../Functions/plotGMPhyloMorphoSpace_plotmod.R")  # modified geomorph function
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/05-residual-data.rda")
```

### Plot residuals - IMPORTANT FIGURE
Color and legend by species
```{r}
residuals <- Allom.all.plus.consensus  # shape data
alpha.names <- dimnames(mean.shapes)[[3]]

res.PCA <- plotTangentSpace(residuals, groups = alpha.col, label = alpha.names)

# Make axis labels
PCs <- res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1", " (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2", " (", PCy.per, "%)", sep = "")
        
# Pretty plot
PCA.plot <- plot(x = -res.PCA$pc.scores[, 1],  # Flip for consistency
                 y = -res.PCA$pc.scores[, 2],  
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 asp = TRUE,
                 xlim = c(-0.12, 0.18),
                 ylim = c(-0.18, 0.12),
                 col = alpha.col, 
                 pch = alpha.pch, 
                 bg = alpha.col,
                 cex = 1.5,
                 cex.axis = 1.3, 
                 cex.lab = 1.3)
legend("bottomright", phylo.names, col = col.unique.spp, pch = pch.unique.spp, pt.bg = col.unique.spp, cex = .57, pt.cex = .7, ncol = 2)
```

### Plot PCA by diet / guild -- NEEDS HELP
```{r}
# Set up colors by diet
warm <- sequential_hcl(5, "LaJolla")  
col.carn <- warm[4]  # meat colored red
col.frug <- warm[3]  # fruit colored orange
col.gran <- warm[2]  # grain colored gold
col.herb <- sequential_hcl(5, "Greens 3")[2]  # green colored grass
col.omni <- sequential_hcl(5, "Grays")[3]  # gray for anything goes

# Define color pallete for diets of all specimens
col.diet <- c(col.carn, col.frug, col.gran, col.herb, col.omni)
col.diet <- PlotByGroup(info.means, "Feeding", col.diet)

# Points: Aquatic, Arboreal (triangle), Terrestrial (square)
pch.gld <- c(19, 24, 22)
pch.gld <- PlotByGroup(info.means, "Guild", pch.gld)
pch.gld[which(info.means$Genus == "Not")] <- 19  # Hopping (circle) 
# Pretty plot
PCA.plot <- plot(x = -res.PCA$pc.scores[, 1],
                 y = -res.PCA$pc.scores[, 2], 
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 asp = TRUE,
                 #xlim = c(-0.12, 0.2),
                 #ylim = c(-0.1, 0.1),
                 col = col.diet, 
                 pch = pch.gld, 
                 bg = col.diet,
                 cex = 1.5,
                 cex.axis = 1.3, 
                 cex.lab = 1.3)
legend("bottomright", legend = c("Arboreal", "Terrest.", "Hopping"), col = "black", border = NULL, pch = c(24, 22, 21))
legend("topright", legend = c("Carnivorous", "Frugivorous", "Granivorous", "Foliverous", "Omnivorous"), col = col.diet, border = NULL, pch = 15)
```

## Plot warp grids of small versus large specimens
Uses Dr Thomas Guillerme's new package, `landvR` to see how landmarks vary within and between the two protocols.
```{r}
# Find mean configuration - i.e. mean shape in dataset
all.consensus <- (select.procrustes(residuals, selector = mean))[[1]]

# Measure spherical coordinates differences from the mean for each specimen for each landmark
diff.from.mean <- coordinates.difference(coordinates = residuals, reference = all.consensus, type = "spherical")

# Find largest and smallest native species from mean centroid size
big.index <- which(info.means$MeanCsize == max(info.means$MeanCsize))
biggest.shape <- mean.shapes[, , big.index]
sm.index <- which(info.means$Species == "del")
smallest.shape <- mean.shapes[, , sm.index]

```

# Plot the variation in residual shape change
Export images for plots
```{r}
# Dorsal view of median to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(all.consensus, biggest.shape, col = heat.colors, col.val = diff.from.mean$Uromys_caudimaculatus[, "radius"])
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_mean-big_dor.png")

# Lateral view of median to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(all.consensus, biggest.shape, col = heat.colors, col.val = diff.from.mean$Uromys_caudimaculatus[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_mean-big_lat.png")


# Dorsal view of median to smallest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(smallest.shape, all.consensus, col = heat.colors, col.val = diff.from.mean$Pseudomys_delicatulus[, "radius"]) 
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_mean-sm_dor.png")

# Lateral view of median to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(smallest.shape, all.consensus, col = heat.colors, col.val = diff.from.mean$Pseudomys_delicatulus[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_mean-sm_lat.png")

# Remove whitespace (requires ImageMagik)
system("mogrify ../Data/Processed/heatmap_*.png -trim ../Data/Processed/*.png")
```

## Make heatmap plot comparisons
```{r}
# PC1 Dorsal view
open3d(windowRect = c(0, 0, 600, 600))
res.PC1.var.plot <- procrustes.var.plot(smallest.shape, biggest.shape, col = heat.colors, col.val = diff.from.mean, labels = F)
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_PC1_dor.png")  # save screenshot for multipanel plot

# PC1 Lateral view
open3d(windowRect = c(0, 0, 600, 600))
res.PC1.var.plot <- procrustes.var.plot(res.hypothetical.1, res.hypothetical.2, col = heat.colors, col.val = res.PC1.var[, "radius"], labels = F)
view3d(phi = 90)
rgl.snapshot("../Data/Processed/res_heatmap_PC1_lat.png")

# PC2 Dorsal view
open3d(windowRect = c(0, 0, 600, 600))
res.PC2.var.plot <- procrustes.var.plot(res.hypothetical.3, res.hypothetical.4, col = heat.colors, col.val = res.PC2.var[, "length"], labels = F)
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/res_heatmap_PC2_dor.png")

# PC2 Lateral view
open3d(windowRect = c(0, 0, 600, 600))
res.PC2.var.plot <- procrustes.var.plot(res.hypothetical.3, res.hypothetical.4, col = heat.colors, col.val = res.PC2.var[, "length"], labels = F)
view3d(phi = 90)
rgl.snapshot("../Data/Processed/res_heatmap_PC2_lat.png")
```

### Make quick figure comparing PC1 of with allometry vs without (residuals)
NOTE: this needs to be reproducible. Currently uses PNGs from allometry rodent side
```{r}
# Load in images
morph.dor.1 <- readPNG("../Data/Processed/PC1heatmap_dor.png")
morph.lat.1 <- readPNG("../Data/Processed/PC1heatmap_lat.png")

system("mogrify ../Data/Processed/res_heatmap_PC1_*.png -trim ../Data/Processed/*.png")  # removes whitespace (requires ImageMagik)
res.dor.1 <- readPNG("../Data/Processed/res_heatmap_PC1_dor.png")
res.lat.1 <- readPNG("../Data/Processed/res_heatmap_PC1_lat.png")

# Set up muli-panel figure
mat <- matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE)  # 2 rows, 2 columns
layout(mat, widths = c(1, 1, 1), heights = c(0.65, 0.75, 0.5))  

# 1) With Allometry: PC1 lateral view
par(mar = c(0, 0, 1, 0))  # sets the margins
plot(c(0, dim(morph.dor.1)[2]), c(0, dim(morph.dor.1)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(morph.dor.1, 0, 0, dim(morph.dor.1)[2], dim(morph.dor.1)[1])
text(0, dim(morph.dor.1)[1]-10, "A", cex = 2)

# 2) Without Allometry: PC1 lateral view
par(mar = c(0, 0, 1, 0))
plot(c(0, dim(morph.lat.1)[2]), c(0, dim(morph.lat.1)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(morph.lat.1, 0, 0, dim(morph.lat.1)[2], dim(morph.lat.1)[1])
text(0, dim(morph.lat.1)[1]-10, "B", cex = 2)

# 3) With Allometry: PC1 dorsal view
par(mar = c(0, 0, 1, 0)) 
plot(c(0, dim(res.dor.1)[2]), c(0, dim(res.dor.1)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(res.dor.1, 0, 0, dim(res.dor.1)[2], dim(res.dor.1)[1])
text(0, dim(res.dor.1)[1]-10, "C", cex = 2)

# 4) Without Allometry: PC1 dorsal view
par(mar = c(0, 0, 1, 0))  
plot(c(0, dim(res.lat.1)[2]), c(0, dim(res.lat.1)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(res.lat.1, 0, 0, dim(res.lat.1)[2], dim(res.lat.1)[1])
text(0, dim(res.lat.1)[1]-10, "D", cex = 2)

```

### Make figure comparing PC2 of with-allometry vs residuals
NOTE: would be best if residuals were generated in script 03


## Remove *Notomys* because differences are known
```{r}
# No Notomys = not
not <- which(info.means$Genus == "Not")
not.info.means <- info.means[-not, ]  # metadata
not.residuals <- residuals[, , -not]  # shape data
not.alpha.cols <- alpha.cols[-not]  # colors
not.alpha.pch <- alpha.pch[-not]  # pch synbols
not.alpha.names <- alpha.names[-not]  # names (for plot labels)

not.col.diet <- col.diet[-not]  # diet colors
not.pch.gld <- pch.gld[-not]  # guild point symbols

# For legend
noto <- which(grepl("N ", names(phylo.cols)))
not.phylo.cols <- phylo.cols[-noto]  # colors
not.phylo.pch <- phylo.pch[-noto]  # pch synbols
not.phylo.names <- phylo.names[-noto]  # names
```

### Plot residuals without *Notomys*
```{r}
not.res.PCA <- plotTangentSpace(not.residuals, groups = not.alpha.cols, label = not.alpha.names)

# Make axis labels
PCs <- not.res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1", " (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2", " (", PCy.per, "%)", sep = "")
        
# Pretty plot
PCA.plot <- plot(x = not.res.PCA$pc.scores[, 1],
                 y = not.res.PCA$pc.scores[, 2], 
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 xlim = c(-0.12, 0.16),
                 ylim = c(-0.07, 0.08),
                 col = not.alpha.cols, 
                 pch = not.alpha.pch, 
                 bg = not.alpha.cols,
                 cex = 1.5,
                 cex.axis = 1.3, 
                 cex.lab = 1.3)
legend("topright", not.phylo.names, col = not.phylo.cols, pch = not.phylo.pch, pt.bg = not.phylo.cols, cex = .63, pt.cex = 1.5, ncol = 2)
```

### Plot phylomorphospace on residuals without *Notomys*
```{r}
# Prep Aus tree by removing species removed from shape data
concord <- name.check(aus.tree, aus.tree$tip.label, dimnames(not.residuals)[[3]])  # check concordance
no.not.tree <- drop.tip(aus.tree, concord$tree_not_data)  # prune tree to Aus sample

# Run with trimmed tree (31 spp) using modified function from `geomorph`
gray.branches.10 <- rep("dark gray", length(gray.branches.10)) # needed handle decision to no longer color the branches

plotGMPhyloMorphoSpace_plotmod(no.not.tree, not.residuals, xaxis = 1, yaxis = -2, tip.labels = FALSE, node.labels = FALSE, plot.param = list(t.bg = not.alpha.cols, t.pch = not.alpha.pch, t.cex = 1.5, n.cex = .75, lwd = 2, l.col = "gray", main = "PCA Phylomorphospace (residuals no Notomys)", xlim = c(-0.12, 0.16), ylim = c(-0.07, 0.08)))


```

### Plot residuals with diet and locomotion
```{r}
# Pretty plot
PCA.plot <- plot(x = not.res.PCA$pc.scores[, 1],
                 y = not.res.PCA$pc.scores[, 2], 
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 xlim = c(-0.12, 0.16),
                 ylim = c(-0.07, 0.08),
                 col = not.col.diet, 
                 pch = not.pch.gld, 
                 bg = not.col.diet,
                 cex = 1.5,
                 cex.axis = 1.3, 
                 cex.lab = 1.3)
legend("bottomright", legend = c("Arboreal", "Terrest."), col = "black", border = NULL, pch = c(24, 22))
legend("topright", legend = c("Frugivorous", "Granivorous", "Foliverous", "Omnivorous"), col = col.diet, border = NULL, pch = 15)
```


## Plot warp grids of PC1
Uses Dr Thomas Guillerme's new package, `landvR` to see how landmarks vary within and between the two protocols. Much of the below was adapted from [this vignette written by Dr Guillerme](https://cdn.rawgit.com/TGuillerme/landvR/8a6a6bd5/inst/vignettes/Landmark_partition_test.html).
```{r}
# Find mean configuration - i.e. mean shape in dataset
all.consensus <- (select.procrustes(not.residuals, selector = mean))[[1]]

# Measure spherical coordinates differences from the mean for each specimen for each landmark
diff.from.mean <- coordinates.difference(coordinates = not.residuals, reference = all.consensus, type = "spherical")
```

To test the hypothesis that each landmark's variation from the mean configuration is above expected, we can use the PC axes from a PCA.
```{r}
# Ordinate the data
twoD.shape <- two.d.array(not.residuals)
ordination <- stats::prcomp(twoD.shape)

# Force the symmetric component of shape into class "gpagen" (required for variation.range)
res.gpagen.shape <- list()
res.gpagen.shape$coords <- not.residuals
res.gpagen.shape$consensus <- all.consensus
class(res.gpagen.shape) <- "gpagen"

# Measure extremes of variation from mean on PC1
res.PC1.var <- variation.range(res.gpagen.shape, return.ID = FALSE, axis = 1, ordination = ordination, type = "spherical")
```

The next step is to make a heatmap showing the size of variation and direction of movement for each landmark in the dataset, comparing between the min and max specimens along PC1.
```{r}
# Wrap specimens on the tangent space
res.wrap.PCA <- plotTangentSpace(not.residuals, verbose = FALSE)

# Select extreme specimens (the ones that make the warp-meshes) on PC1
res.hypothetical.1 <- res.wrap.PCA$pc.shapes[[1]]  # PC1 min
res.hypothetical.2 <- res.wrap.PCA$pc.shapes[[2]]  # PC1 max
```

**Repeat the steps immediately above for PC2**
The pc.shapes[1] and [2] correspond to PC1min and PC1max. Therefore we can adjust the same res.wrap.PCA to plot the heatmaps for PC2. 
```{r}
# Measure extremes of variation from mean on PC2
res.PC2.var <- variation.range(res.gpagen.shape, return.ID = FALSE, axis = 2, ordination = ordination, type = "vector")  # can also try "spherical"

# Select extreme specimens on PC2
res.hypothetical.3 <- res.wrap.PCA$pc.shapes[[3]]  # PC2 min
res.hypothetical.4 <- res.wrap.PCA$pc.shapes[[4]]  # PC2 max
```

## Make heatmap plot comparisons
```{r}
# PC1 Dorsal view
open3d(windowRect = c(0, 0, 600, 600))
res.PC1.var.plot <- procrustes.var.plot(res.hypothetical.1, res.hypothetical.2, col = heat.colors, col.val = res.PC1.var[, "radius"], labels = F)
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_PC1_dor_NOt.png")  # save screenshot for multipanel plot

# PC1 Lateral view
open3d(windowRect = c(0, 0, 600, 600))
res.PC1.var.plot <- procrustes.var.plot(res.hypothetical.1, res.hypothetical.2, col = heat.colors, col.val = res.PC1.var[, "radius"], labels = F)
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_PC1_lat_NOt.png")

# PC2 Dorsal view
open3d(windowRect = c(0, 0, 600, 600))
res.PC2.var.plot <- procrustes.var.plot(res.hypothetical.3, res.hypothetical.4, col = heat.colors, col.val = res.PC2.var[, "length"], labels = F)
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_PC2_dor_NOt.png")

# PC2 Lateral view
open3d(windowRect = c(0, 0, 600, 600))
res.PC2.var.plot <- procrustes.var.plot(res.hypothetical.3, res.hypothetical.4, col = heat.colors, col.val = res.PC2.var[, "length"], labels = F)
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_PC2_lat_NOt.png")
```
