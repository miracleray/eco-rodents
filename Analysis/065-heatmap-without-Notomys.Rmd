---
title: "065-heatmap-without-Notomys"
author: "Ariel Marcy"
date: "2/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Check that heatmaps patterns with residuals hold without *Notomys*
Taking out the bipedally hopping *Notomys* is a check to see that the postural signal we are getting in the residuals holds for all other (quadrupedal) taxa.

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)
library(data.table)
library(stringr)
library(vegan)
library(geiger)  # for phylogenies
library(png)  # needed to work with screenshots
library(colorspace)  # plot colors

# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
source("../Functions/utilities.R")  # custom functions
source("../Functions/plotGMPhyloMorphoSpace_plotmod.R")  # modified geomorph function
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/04-PCA.rda")
load(file = "../Data/Processed/05-residual-data.rda")
```

## 1) Remove *Notomys* from datasets
```{r}
index.rm <- str_detect(dimnames(residuals)[[3]], "Notomys")
res.no.not <- residuals[, , !index.rm]  # remove Notomys from shape dataset
res.PCA.not <- plotTangentSpace(res.no.not)  # residuals PCA without Notomys

# For exploratory plotting
alpha.col.not <- alpha.col[!index.rm]  # color
alpha.pch.not <- alpha.pch[!index.rm]  # points
phylo.names.not <- phylo.names[!index.rm]  # names for legend
```

## 3) Heatmaps for PC1 with residual coordinates
Steps as in script 06-heatmap-both-datasets.
```{r}
# Find mean configuration - i.e. mean shape in dataset
res.mean <- (select.procrustes(res.no.not, selector = mean))[[1]]

# Measure spherical coordinates differences from the mean for each specimen for each landmark
res.diff.mean <- coordinates.difference(coordinates = res.no.not, reference = res.mean, type = "spherical")

# Find min and max shapes    
r.min.name <- names(which(res.PCA.not$pc.scores[, 1] == min(res.PCA.not$pc.scores[, 1])))
r.max.name <- names(which(res.PCA.not$pc.scores[, 1] == max(res.PCA.not$pc.scores[, 1])))
PC.res.min <- res.no.not[, , which(dimnames(res.no.not)[[3]] == r.min.name)]
PC.res.max <- res.no.not[, , which(dimnames(res.no.not)[[3]] == r.max.name)]
```

### Export the variation for residual shape change
Export images for plots.
```{r}
# Lateral view of mean to smallest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res.min, col = heat.colors, col.val = res.diff.mean$Pseudomys_novaehollandiae[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_RES_sm-mean_lat_NOt.png")

# Lateral view of mean to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res.max, col = heat.colors, col.val = res.diff.mean$Hydromys_chrysogaster[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_RES_mean-big_lat_NOt.png")

# Dorsal view of mean to smallest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res.min, col = heat.colors, col.val = res.diff.mean$Pseudomys_novaehollandiae[, "radius"]) 
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_RES_sm-mean_dor_NOt.png")

# Dorsal view of mean to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res.max, col = heat.colors, col.val = res.diff.mean$Hydromys_chrysogaster[, "radius"])
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_RES_mean-big_dor_NOt.png")
```

## 4) Heatmaps for PC2 with residual coordinates
Steps as above.
```{r}
# Find min and max shapes on PC2
r2.min.name <- names(which(res.PCA.not$pc.scores[, 2] == min(res.PCA.not$pc.scores[, 2])))
r2.max.name <- names(which(res.PCA.not$pc.scores[, 2] == max(res.PCA.not$pc.scores[, 2])))
PC.res2.min <- res.no.not[, , which(dimnames(res.no.not)[[3]] == r2.min.name)]
PC.res2.max <- res.no.not[, , which(dimnames(res.no.not)[[3]] == r2.max.name)]
```

### Export the variation for residual shape change
Export images for plots.
```{r}
# Lateral view of mean to smallest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res2.min, col = heat.colors, col.val = res.diff.mean$Mastacomys_fuscus[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_RP2_sm-mean_lat_NOt.png")

# Lateral view of mean to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res2.max, col = heat.colors, col.val = res.diff.mean$Pseudomys_delicatulus[, "radius"])
view3d(phi = 90)
rgl.snapshot("../Data/Processed/heatmap_RP2_mean-big_lat_NOt.png")

# Dorsal view of mean to smallest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res2.min, col = heat.colors, col.val = res.diff.mean$Mastacomys_fuscus[, "radius"]) 
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_RP2_sm-mean_dor_NOt.png")

# Dorsal view of mean to biggest
open3d(windowRect = c(0, 0, 600, 600))
procrustes.var.plot(res.mean, PC.res2.max, col = heat.colors, col.val = res.diff.mean$Pseudomys_delicatulus[, "radius"])
view3d(phi = 0)  # flip cranium
rgl.snapshot("../Data/Processed/heatmap_RP2_mean-big_dor_NOt.png")
```

### 5) Make multipanel figure comparing shape change between smallest-to-mean and mean-to-largest, with allometry vs without (residuals)
First, clean up and load in all the images just created
```{r}
# Remove whitespace from all heatmaps (requires ImageMagik installed on PC)
system("mogrify ../Data/Processed/heatmap_*.png -trim ../Data/Processed/*.png")

# Load in without allometry residuals PC1
resid.sm.lat <- readPNG("../Data/Processed/heatmap_RES_sm-mean_lat_NOt.png")
resid.big.lat <- readPNG("../Data/Processed/heatmap_RES_mean-big_lat_NOt.png")
resid.sm.dor <- readPNG("../Data/Processed/heatmap_RES_sm-mean_dor_NOt.png")
resid.big.dor <- readPNG("../Data/Processed/heatmap_RES_mean-big_dor_NOt.png")

# Load in without allometry residuals PC2
resP2.sm.lat <- readPNG("../Data/Processed/heatmap_RP2_sm-mean_lat_NOt.png")
resP2.big.lat <- readPNG("../Data/Processed/heatmap_RP2_mean-big_lat_NOt.png")
resP2.sm.dor <- readPNG("../Data/Processed/heatmap_RP2_sm-mean_dor_NOt.png")
resP2.big.dor <- readPNG("../Data/Processed/heatmap_RP2_mean-big_dor_NOt.png")
```

## Make multi-panel Figure TK Part 3: Residuals without Notomys
```{r}
# Set up muli-panel figure; lateral 
mat <- matrix(c(1:8), 4, 2, byrow = TRUE)  # 4 rows, 2 columns
layout(mat, widths = c(1, 1, 1), heights = c(0.65, 0.75, 0.5))  

## LATERAL VIEWS
# 1) Small to Mean, residuals PC1, lateral view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resid.sm.lat)[2]), c(0, dim(resid.sm.lat)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resid.sm.lat, 0, 0, dim(resid.sm.lat)[2], dim(resid.sm.lat)[1])
text(0, dim(resid.sm.lat)[1]-10, "Q", cex = 2)

# 2) Small to Mean, residuals PC2, lateral view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resP2.sm.lat)[2]), c(0, dim(resP2.sm.lat)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resP2.sm.lat, 0, 0, dim(resP2.sm.lat)[2], dim(resP2.sm.lat)[1])
text(0, dim(resP2.sm.lat)[1]-10, "R", cex = 2)

# 3) Mean to Big, residuals PC1, lateral view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resid.big.lat)[2]), c(0, dim(resid.big.lat)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resid.big.lat, 0, 0, dim(resid.big.lat)[2], dim(resid.big.lat)[1])
text(0, dim(resid.big.lat)[1]-10, "S", cex = 2)

# 4) Mean to Big, residuals PC2, lateral view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resP2.big.lat)[2]), c(0, dim(resP2.big.lat)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resP2.big.lat, 0, 0, dim(resP2.big.lat)[2], dim(resP2.big.lat)[1])
text(0, dim(resP2.big.lat)[1]-10, "T", cex = 2)

## DORSAL VIEWS
# 5) Small to Mean, residuals PC1, dorsal view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resid.big.dor)[2]), c(0, dim(resid.big.dor)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resid.sm.dor, 0, 0, dim(resid.big.dor)[2], dim(resid.big.dor)[1])
text(0, dim(resid.big.dor)[1]-10, "U", cex = 2)

# 6) Small to Mean, residuals PC2, dorsal view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resP2.big.dor)[2]), c(0, dim(resP2.big.dor)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resP2.sm.dor, 0, 0, dim(resP2.big.dor)[2], dim(resP2.big.dor)[1])
text(0, dim(resP2.big.dor)[1]-10, "V", cex = 2)

# 7) Mean to Big, residuals PC1, dorsal view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resid.big.dor)[2]), c(0, dim(resid.big.dor)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resid.big.dor, 0, 0, dim(resid.big.dor)[2], dim(resid.big.dor)[1])
text(0, dim(resid.big.dor)[1]-10, "W", cex = 2)

# 8) Mean to Big, residuals PC2, dorsal view
par(mar = c(0, 0, 0, 0))
plot(c(0, dim(resP2.big.dor)[2]), c(0, dim(resP2.big.dor)[1]), type = "n", axes = F, xlab = "", ylab = "", asp = T) 
rasterImage(resP2.big.dor, 0, 0, dim(resP2.big.dor)[2], dim(resP2.big.dor)[1])
text(0, dim(resP2.big.dor)[1]-10, "X", cex = 2)
```