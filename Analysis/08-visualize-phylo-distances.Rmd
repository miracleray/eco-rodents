---
title: "08-visualize-phylo-distances"
author: "Ariel Marcy"
date: "1/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Test phylo-morpho distances
Assess limits of morphological divergence as it relates to phylogenetic distance.

### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(geomorph)
library(stringr)
library(picante)  # needed for distance matrix
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/05-residual-data.rda")
```

## Analyze phylogenetic and morphological distance matrices
To analyze phylogenetic and morphological distance in the context of biomes, we first need to generate distances matrices that can be comparable.
```{r}
# Phylo distance matrix
phylo.matrix <- cophenetic(aus.tree) / 2  # divide by two to convert distance to millions of years since Last Common Ancestor

# Morphological distance matrix
mean.gpa <- gpagen(mean.shapes, ProcD = TRUE)  # use mean shapes of species
morph.matrix <- as.matrix(mean.gpa$procD)

# Make names shorter
long.names <- colnames(phylo.matrix)
short.names <- NULL 
for(i in 1:length(long.names)) {
        sep <- strsplit(long.names[i], "_")
        new.name <- paste(str_sub(sep[[1]][1], 1, 3), str_sub(sep[[1]][2], 1, 3), sep = "_")
        short.names <- c(short.names, new.name)
}

# Replace with short names
row.names(phylo.matrix) <- short.names  # phylo matrix
colnames(phylo.matrix) <- short.names
row.names(morph.matrix) <- short.names  # morph matrix
colnames(morph.matrix) <- short.names
```

### Turn distance matrices into dataframes and then combine
```{r}
# Write function that creates the same, comparable table structure taking in the distance matrices from above, and the name for the distance in the matrix.
make.table <- function(matrix, d.name) {
        new.table <- as.data.frame(as.table(matrix))
        new.table[, 4] <- NA  # initialize pair name column
        colnames(new.table) <- c("spp1", "spp2", d.name, "pair")
        
        # Remove same-same comparisons (where distance = 0)
        new.table <- new.table[which(new.table[, d.name] > 0), ]
        
        # Remove permutations by alphabetizing the species names for each pair
        for(i in 1:dim(new.table)[1]) {
                pair.names <- c(as.character(new.table[i, "spp1"]), as.character(new.table[i, "spp2"]))
                pair.index <- str_order(c(as.character(new.table[i, "spp1"]), as.character(new.table[i, "spp2"])))
                pair <- paste(pair.names[pair.index[1]], pair.names[pair.index[2]], sep = "-")  # pair names in alpha order
                new.table[i, "pair"] <- pair
        }
        
        new.table <- new.table[!duplicated(new.table[, "pair"]), ]  # only unique pair combinations
        return(new.table)
}

# Run on both matrices & merge by pair
phylo.table <- make.table(phylo.matrix, "phylo.d")
morph.table <- make.table(morph.matrix, "morph.d")
master.table <- merge(phylo.table, morph.table[, 3:4], by = "pair")
```

## Plot phylo-morph distance pairs (Figure TK)
```{r}
# Create color key
just.genera <- NULL
for(i in 1:length(short.names)){
        sep <- strsplit(short.names[i], "_")
        just.genera <- c(just.genera, sep[[1]][1])
}
gen.col <- col.phylo[match(just.genera, names(col.phylo))]
names(gen.col)[5] <- "Mas"
gen.col[5] <- gen.col[16]  # Fix Mastacomys color

# Points coded for each individual specimen
alpha.col.spp1 <- gen.col[2:37]  # subset because C pen isn't in this col
alpha.col.spp2 <- gen.col

# Save in table for ease in plotting later on
master.table$col.spp1 <- PlotByGroup(master.table, "spp1", alpha.col.spp1)
master.table$col.spp2 <- PlotByGroup(master.table, "spp2", alpha.col.spp2)
```

## Repeat Phylo/Morph distance plot using residuals
```{r}
# Morphological distance matrix for residuals
mean.gpa.res <- gpagen(residuals, ProcD = TRUE)
morph.matrix.res <- as.matrix(mean.gpa.res$procD)

# Shorten row and column names
row.names(morph.matrix.res) <- short.names
colnames(morph.matrix.res) <- short.names

# Make comparable table to phylo distance using function defined above
morph.table.r <- make.table(morph.matrix.res, "morph.d.r")
master.table.r <- merge(phylo.table, morph.table.r[, 3:4], by = "pair")
```

### Export Figure
```{r}
mat <- matrix(c(1, 2), 2, 1, byrow = TRUE)  # 2 rows, 1 column
layout(mat, widths = c(1, 1, 1), heights = c(0.65, 0.75, 0.5))  

# A) Plot with allometry
par(mar = c(1, 4, 2, 1))
plot(master.table$phylo.d, master.table$morph.d, col = master.table$col.spp1, bg = master.table$col.spp2, pch = 21, ylab = "Morph. distance")
text(0.25, 0.19, "A", cex = 1.5)
legend("topleft", legend = "with allometry", inset = c(0.0, 0), bty = "n")

# B) Plot with residuals
par(mar = c(4.5, 4, 2, 1))
plot(master.table.r$phylo.d, master.table.r$morph.d.r, col = master.table$col.spp1, bg = master.table$col.spp2, pch = 21, xlab = "Phylogenetic distance (~million years since common ancestor)", ylab = "Morph. distance")
text(0.25, 0.255, "B", cex = 1.5)
legend("topleft", legend = "residuals", inset = c(0.0, 0), bty = "n")
```