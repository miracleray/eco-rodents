---
title: "08-visualize-phylo-distances"
author: "Ariel Marcy"
date: "1/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Test biome pairs


### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(geomorph)
library(stringr)
library(picante)  # needed for distance matrix
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/05-residual-data.rda")
```

## Analyze phylogenetic and morphological distance matrices
To analyze phylogenetic and morphological distance in the context of biomes, we first need to generate distances matrices that can be comparable.
```{r}
phylo.matrix <- cophenetic(aus.tree)  # Phylo distance matrix

# Morphological distance matrix
mean.gpa <- gpagen(mean.shapes, ProcD = TRUE)  # use mean shapes of species
morph.matrix <- as.matrix(mean.gpa$procD) 

# Make names shorter
long.names <- colnames(phylo.matrix)
short.names <- NULL 
for(i in 1:length(long.names)) {
        sep <- strsplit(long.names[i], "_")
        new.name <- paste(str_sub(sep[[1]][1], 1, 3), str_sub(sep[[1]][2], 1, 3), sep = "_")
        short.names <- c(short.names, new.name)
}

# Replace with short names
row.names(phylo.matrix) <- short.names
colnames(phylo.matrix) <- short.names

row.names(morph.matrix) <- short.names
colnames(morph.matrix) <- short.names
```

### Turn distance matrices into dataframes and then combine
```{r}
# Write function that creates the same, comparable table structure taking in the distance matrices from above, and the name for the distance in the matrix.
make.table <- function(matrix, d.name) {
        new.table <- as.data.frame(as.table(matrix))
        new.table[, 4] <- NA  # initialize pair name column
        colnames(new.table) <- c("spp1", "spp2", d.name, "pair")
        
        # Remove same-same comparisons (where distance = 0)
        new.table <- new.table[which(new.table[, d.name] > 0), ]
        
        # Remove permutations by alphabetizing the species names for each pair
        for(i in 1:dim(new.table)[1]) {
                pair.index <- str_order(c(new.table[i, 1], new.table[i, 2]))
                new.table[i, 4] <- paste(new.table[i, pair.index[1]], new.table[i, pair.index[2]], sep = "-")  # pair names in alpha order
        }
        new.table <- new.table[!duplicated(new.table[, 3:4]), ]  # only unique pair combinations

        return(new.table)
}

# Run on both matrices & merge by pair
phylo.table <- make.table(phylo.matrix, "phylo.d")
morph.table <- make.table(morph.matrix, "morph.d")
master.table <- merge(phylo.table, morph.table[, 3:4], by = "pair")
```

## Plot phylo-morph distance pairs
```{r}
# Get color vectors by names
names <- as.vector(master.table[,"spp1"])[1:36]
names <- c("Con_pen", names)

# Create color key
just.genera <- NULL
for(i in 1:length(names)){
        sep <- strsplit(names[i], "_")
        just.genera <- c(just.genera, sep[[1]][1])
}
gen.col <- col.phylo[match(just.genera, names(col.phylo))]
gen.col[5] <- gen.col[16]  # Fix mastacomys
names(gen.col)[5] <- "Mas"

# Points coded for each individual specimen
alpha.col.spp1 <- gen.col[2:37]  # subset because C pen isn't in this col
alpha.col.spp2 <- gen.col

col.spp1 <- PlotByGroup(master.table, "spp1", alpha.col.spp1)
col.spp2 <- PlotByGroup(master.table, "spp2", alpha.col.spp2)

# Plot
plot(master.table$phylo.d, master.table$morph.d, col = col.spp2, bg = col.spp1, pch = 21, xlab = "Phylogenetic distance", ylab = "Morphological distance")
```

## 

