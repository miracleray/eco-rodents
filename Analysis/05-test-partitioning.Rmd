---
title: "05-test-partitioning"
author: "Ariel Marcy & Vera Weisbecker"
date: "8/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Test biome partitioning 
First, testing for a phylogenetic signal difference in each of the 7 regional biomes. 

Second, testing for partitioning by region in the residual shapes (size-less shape)

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)
library(dplyr)
library(geiger)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/01-bilat-data-w-ERR.rda")
load(file = "../Data/Processed/03-sm-PCA-with-color.rda")
load(file = "../Data/Processed/04-sm-data-with-traits.rda")
load(file = "../Data/Processed/allometry_rodents_04-phylo-data.rda")  # includes phylogenetic tree from Allometry Rodents paper
```

## Assess phylogenetic signal overall
Baseline comparison.
```{r}
# Test phylogenetic signal
physig.all <- physignal(mean.shapes.tree, aus.tree)
summary(physig.all)
```

## 1) Assess phylogenetic signal in each region partition
Here, again, we subset the PCA scores by species which inhabit the 7 different ecological regions of Australia. We'll use a loop to test the phylogenetic signal in each region. 

Evolutionary tree comes from the Allometry Paper repo. 
```{r}
info.means.tree$Order <- c(1:nrow(info.means.tree))  # preserves order with coordinate shape data

# Set up loop for particular regions in Australia
region.names <- c("Savannah", "Arid Zone", "NE Wet Forest", "NE Dry Forest", "Pilbara", "South West", "South East")
n.taxa <- c(rep("NA", length(region.names)))
K.region <- c(rep("NA", length(region.names)))
p.region <- c(rep("NA", length(region.names)))

# Loop through all 7 regions to plot morphospace of species found in each
for (i in 1:7) {
        # Identify species found in the region
        spp.in.region <- FoundInRegion(traits, regions = i)
        spp.region <- traits[spp.in.region, ]
        
        # Subset metadata by region
        temp <- info.means.tree[, c("Taxa", "MeanCsize", "FullName", "Order")]
        meta.region <- merge(spp.region, temp, by = "Taxa")
        
        # Subset shape coordinates by region
        shape.region <- mean.shapes.tree[, , meta.region$Order]
        
        # Subset tree by species in the region
        concord <- name.check(aus.tree, data.names = meta.region$FullName)  # check concordance
        region.tree <- drop.tip(aus.tree, concord$tree_not_data)  # prune tree to regional sample
        n.taxa[i] <- length(region.tree$tip.label)
        
        # Re-order to match tree tip order
        tree.order <- match(region.tree$tip.label, meta.region$FullName)
        meta.region <- meta.region[tree.order, ]  # metadata
        shape.region <- shape.region[, , tree.order]  # shape data
        
        # Test phylogenetic signal
        physig.region <- physignal(shape.region, region.tree)
        K.region[i] <- round(physig.region$phy.signal, 3)
        p.region[i] <- as.numeric(physig.region$pvalue)  # round after Bonferroni correction in next code chuck
}
```

### Make and export Table TK
Create and export Table TK. Includes Bonferroni p-value adjustment for running 7 biomes. 
```{r}
p.region <- round(p.adjust(p.region, method = "bonferroni"), 3)

table <- cbind(n.taxa, K.region, p.region)
colnames(table) <- c("N Taxa", "Phy. Signal", "p Value (cor.)")
row.names(table) <- region.names

write.table(table, "../Data/Results/Table_RegionPhySig.csv", sep = ",", col.names = NA)
```

## 2) Do same analysis but for centroid size only
```{r}
# Set up blank variables again for results table
n.taxa <- c(rep("NA", length(region.names)))
K.region <- c(rep("NA", length(region.names)))
p.region <- c(rep("NA", length(region.names)))

# Loop through all 7 regions to plot morphospace of species found in each
for (i in 1:7) {
        # Identify species found in the region
        spp.in.region <- FoundInRegion(traits, regions = i)
        spp.region <- traits[spp.in.region, ]
        
        # Subset metadata by region
        temp <- info.means.tree[, c("Taxa", "MeanCsize", "FullName", "Order")]
        meta.region <- merge(spp.region, temp, by = "Taxa")
        
        # Subset tree by species in the region
        concord <- name.check(aus.tree, data.names = meta.region$FullName)  # check concordance
        region.tree <- drop.tip(aus.tree, concord$tree_not_data)  # prune tree to regional sample
        n.taxa[i] <- length(region.tree$tip.label)
        
        # Re-order to match tree tip order
        tree.order <- match(region.tree$tip.label, meta.region$FullName)
        meta.region <- meta.region[tree.order, ]  # metadata
        
        # Test phylogenetic signal with centroid size
        Csize <- as.numeric(meta.region$MeanCsize)
        names(Csize) <- meta.region$FullName
        physig.region <- physignal(Csize, region.tree) 
        K.region[i] <- round(physig.region$phy.signal, 3)
        p.region[i] <- as.numeric(physig.region$pvalue)  # round after Bonferroni correction in next code chuck
}
```

### Make and export Table TK
Create and export Table TK. Includes Bonferroni p-value adjustment for running 7 biomes and filename indicating these results are for centroid size. 
```{r}
p.region <- round(p.adjust(p.region, method = "bonferroni"), 3)

table <- cbind(n.taxa, K.region, p.region)
colnames(table) <- c("N Taxa", "Phy. Signal", "p Value (cor.)")
row.names(table) <- region.names

write.table(table, "../Data/Results/Table_RegionPhySig_Csize.csv", sep = ",", col.names = NA)
```

## PCA with mean shape for comparison
```{r}
mean.pca <- plotTangentSpace(mean.shapes.tree, axis1 = 1, axis2 = 2, verbose = T)
PlotPCA(mean.pca, 1, 2, alpha.cols, alpha.pch, flip.axis1 = T)
```

## 3) Check biome partitioning WITHOUT allometry and WITH phylogenetic correction
First, extract residuals - code thanks to Dr Vera Weisbecker
```{r}
# Use pgls of coords with size to get residuals
allom.GDF <- geomorph.data.frame(coords = mean.shapes.tree, Csize = info.means.tree$MeanCsize) 

dimnames(mean.shapes.tree)[[3]]==info.means.tree$FullName

allometry.all <- procD.pgls(coords ~ Csize, aus.tree, data = allom.GDF)
summary(allometry.all)

# Turn the residuals into an appropriate array
allom.resid <- arrayspecs(allometry.all$pgls.residuals, dim(mean.shapes.tree)[[1]], 3)

# Add the consensus shape (from the GPA) to the residuals if you want to understand the landmark variation in the residuals - needed for script 06
Allom.all.plus.consensus <- allom.resid + array(mean.shapes.tree, dim(allom.resid))
```

### Then, plot residuals
```{r}
# Get names and other vectors in alphabetical order
re.do <- match(info.means.tree$Taxa, names(phylo.cols))
alpha.cols <- phylo.cols[re.do]
alpha.pch <- phylo.pch[re.do]
alpha.names <- phylo.names[re.do]

# Run PCA on residuals
res.PCA <- plotTangentSpace(Allom.all.plus.consensus, groups = alpha.cols)
PlotPCA(res.PCA, 1, 2, alpha.cols, alpha.pch)
legend("bottomright", phylo.names, col = phylo.cols, pch = phylo.pch, pt.bg = phylo.cols, cex = .53, pt.cex = 1.5, ncol = 2)
```

```{r}
res.PCA <- plotTangentSpace(allom.resid, groups = alpha.cols)
PlotPCA(res.PCA, 1, 2, alpha.cols, alpha.pch)
legend("bottomright", phylo.names, col = phylo.cols, pch = phylo.pch, pt.bg = phylo.cols, cex = .53, pt.cex = 1.5, ncol = 2)

```


### Finally, plot residuals by region
```{r}
# Set up loop for particular regions in Australia
region.names <- c("Savannah", "Arid Zone", "NE Wet Forest", "NE Dry Forest", "Pilbara", "South West", "South East")
res.pc.scores <- subset(res.PCA$pc.scores, select = 1:3)  # only 1st 3 PCs

# Write x and y labels with proportion of variance for PCx and PCy
PCs <- res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1 (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2 (", PCy.per, "%)", sep = "")

par(mfrow = c(4, 2), mar = c(2, 2, 2, 2))
# Loop through all 7 regions to plot morphospace of species found in each
for (i in 1:7) {
        # Subset info.traits and PCA by region
        spp.in.region <- FoundInRegion(traits, regions = i)
        spp.region <- traits[spp.in.region, ]
        
        # Subset metadata by region
        temp <- info.means.tree[, c("Taxa", "MeanCsize", "FullName", "Order")]
        meta.region <- merge(spp.region, temp, by = "Taxa")
        
        # Subset PCA coordinates by region
        res.pc.region <- as.data.frame(res.pc.scores[meta.region$Order, ])
        
        # Subset plotting colors and pch symbols for spp in region
        col.taxa.region <- alpha.cols[meta.region$Order]  # colors for all spp
        pch.taxa.region <- alpha.pch[meta.region$Order]  # pch for all spp
        
        # Plot PCA with legend and labels
        PCA.plot <- plot(x = res.pc.region$PC1,
                         y = res.pc.region$PC2,
                         main = paste(region.names[i], "Residual Morphospace" ),
                         xlab = PCx.lab,
                         ylab = PCy.lab,
                         xlim = c(-0.12, 0.15),
                         ylim = c(-0.1, 0.2),
                         col = col.taxa.region, 
                         pch = pch.taxa.region, 
                         bg = col.taxa.region,
                         cex = 1.5,
                         cex.axis = 1.3, 
                         cex.lab = 1.3)
}
```

### Save intermediate data
```{r}
save(alpha.cols, alpha.pch, alpha.names, res.PCA, allom.resid, Allom.all.plus.consensus, file = "../Data/Processed/05-residual-data.rda")
```

### Recycle Bin ###

### A look at ANOVA differences in centroid sizes
```{r}
test.data <- info.traits[, c("Taxa", "Genus", "Species", "CatNum", "Order", "Csize", "Feeding", "Guild")]  # relevant columns

# Take out aquatic carnivores, which skew data
#aquatic <- which(info.traits$Guild == "Aquatic")
#test.data <- test.data[-aquatic, ]  
#test.shape <- shape[, , -aquatic]


# Get summary statistics on each group
group_by(test.data$Csize, Guild) %>% 
        summarise(count = n(test.data$Csize), 
                  mean = mean(test.data$Csize),
                  sd = sd(test.data$Csize)) 

## Visualize data
install.packages("ggpubr")
library("ggpubr")

# Box Plots
ggboxplot(test.data, x = "Guild", y = "Csize", 
          color = "Guild", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("Aquatic", "Arboreal", "Terrestrial"),
          ylab = "Csize", xlab = "Guild")

# Mean Plots
ggline(test.data, x = "Guild", y = "Csize", 
       add = c("mean_se", "jitter"), 
       order = c("Aquatic", "Arboreal", "Terrestrial"),
       ylab = "Csize", xlab = "Guild")

# Run ANOVA on just Csize and Guild
guild.aov <- aov(Csize ~ Guild, data = test.data)
summary(guild.aov)

# Multiple comparisons
TukeyHSD(guild.aov)
```

```{r}
# Run Procrustes ANOVA for guild
test.GDF <- geomorph.data.frame(coords = shape, size = test.data$Csize, guild = test.data$Guild)
procANOVA <- procD.lm(coords ~ size * guild, data = test.GDF)

# Run Procrustes ANOVA for guild
test.GDF <- geomorph.data.frame(coords = test.shape, size = test.data$Csize, feed = test.data$Feeding)
procANOVA <- procD.lm(coords ~ size * guild, data = test.GDF)
```