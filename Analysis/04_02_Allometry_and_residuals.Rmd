---
title: "04-compare_PCAs"
author: "Ariel Marcy & Vera Weisbecker"
date: "8/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Plot PCAs for allometric and shape residual datasets
Plot PCAs for allometric shape and shape residual, provide coloration and pch symbols by locomotion and diet, and visualize changes in shape residual PCA when *Notomys* species are removed. These plots are relevant to the heatplots created in script 05 / shown in Figure 2. 

Creates multipanel Figure 1.

Compares morphospace similarity of the two datasets with Mantel tests and a correlation test.

Creates supplementary Figure 1, a screeplot of the the PCs for each dataset.

Produces shape residual data used in later analyses, stored in rda file 04.

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)   
library(vegan)      
library(dplyr)      
library(colorspace) 
library(phytools) 
library(geiger)      
library(mvMORPH)  
library(qpcR)


# This sets the wd to local
library(rstudioapi) # Safely Access the RStudio API
setwd(dirname(getActiveDocumentContext()$path))

source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file="../Data/Processed/allometry_residuals.rda")

```

#Phylogenetic signal of shape and size
```{r}


physignal(mean.shapes, aus.tree )

#pull out csize so it also has row names and check

log_mean_csize <- log(info.means$MeanCsize)
names(log_mean_csize) <- info.means$FullName
names(log_mean_csize) == aus.tree$tip.label

physignal(log_mean_csize, aus.tree )

```

#Now we want to know if allometry affects all modules equally. 

```{r}

#add empty colums for values
Allometry <- matrix(ncol=7, nrow=length(names(mean_modules)), dimnames=list(c(names(mean_modules)), c("Df", "SS","MS" ,"Rsq", "F", "Z","P")) )


for (i in 1:length(mean_modules)){
  
temp <- procD.pgls( mean_modules[[i]]$shape ~ log(mean_modules[[i]]$csize), phy=aus.tree, iter = 10000)

Allometry[i, 1:7] <- unlist( temp$aov.table[1,])

}


write.csv(Allometry, file="../Data/Results/Module_allometry.csv")

#it is also worth checking whether this pattern holds up if we use the overall csize of the skull, since the datasets are all aligned.

#add empty colums for values
Allometry_fullcsize <- matrix(ncol=7, nrow=length(names(mean_modules)), dimnames=list(c(names(mean_modules)), c("Df", "SS","MS" ,"Rsq", "F", "Z","P")) )


for (i in 1:length(mean_modules)){
  
temp <- procD.pgls( mean_modules[[i]]$shape ~ log(info.means$MeanCsize), phy=aus.tree)

Allometry_fullcsize[i, 1:7] <- unlist( temp$aov.table[1,])

}


```
