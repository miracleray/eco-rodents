---
title: "05-plot_residual_PCAs"
author: "Ariel Marcy & Vera Weisbecker"
date: "8/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Plot PCAs for allometric and residual shape datasets
Plot PCAs for allometric shape and residual shape, provide coloration and pch symbols by locomotion and diet, and review changes in residual shape PCA when *Notomys* species are removed. These plots are relevant to the heatplots created in script 06 / shown in Figure 2. 

Creates multipanel Figure 1.

Produces residual shape data used in later analyses, stored in RDA file 05.

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)
library(dplyr)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
load(file = "../Data/Processed/04-PCA.rda")
```

## 1) Make PCA of mean shapes with allometry
Plot in part A. 
```{r}
PCA.mean.allo <- plotTangentSpace(mean.shapes, groups = alpha.col, label = alpha.names)

# Make axis labels
PCs.allo <- PCA.mean.allo$pc.summary$importance
PCx.per.allo <- round(PCs.allo[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab.allo <- paste("PC1", " (", PCx.per.allo, "%)", sep = "")
PCy.per.allo <- round(PCs.allo[2, 2] * 100, digits = 1)
PCy.lab.allo <- paste("PC2", " (", PCy.per.allo, "%)", sep = "")
```

### Extract shape residuals by removing allometric shape signal
Code thanks to Dr Vera Weisbecker
```{r}
# Use pgls of coords with size to get residuals
allom.GDF <- geomorph.data.frame(coords = mean.shapes, Csize = info.means$MeanCsize) 

dimnames(mean.shapes)[[3]] <- info.means$FullName

allometry.all <- procD.pgls(coords ~ Csize, aus.tree, data = allom.GDF)
summary(allometry.all)

# Turn the residuals into an appropriate array
allom.resid <- arrayspecs(allometry.all$pgls.residuals, dim(mean.shapes)[[1]], 3)

# Add the consensus shape (from the GPA) to the residuals if you want to understand the landmark variation in the residuals - needed for script 06
residuals <- allom.resid + array(mean.shapes, dim(allom.resid))
```

## 2) Find coordinates for residuals with consensus (WITHOUT allometry)
Color and legend by species
```{r}
# PCA in part B and D
res.PCA <- plotTangentSpace(residuals, groups = alpha.col, label = alpha.names)

# Make axis labels
PCs <- res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1", " (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2", " (", PCy.per, "%)", sep = "")
```

## 3) Plot by guild and compare with mean allometry shapes 
Recolor plot above with points by diet and guild
```{r}
# Define color pallete for diets of all specimens
col.diet.means <- PlotByGroup(info.means, "Feeding", col.diet.5)

# Points: Aquatic (circle), Arboreal (triangle), Terrestrial (square)
pch.gld.means <- PlotByGroup(info.means, "Guild", pch.gld.4)
```

## 4) Prepare PCA without Notomys
```{r}
# Remove Notomys from dataset
index.not <- which(info.means$Genus == "Not")
residuals.no <- residuals[, , -index.not]
info.means.no <- info.means[-index.not, ]

# PCA
wrap.PCA.r.n <- plotTangentSpace(residuals.no, verbose = FALSE)
alpha.col.no <- alpha.col[-index.not]
alpha.pch.no <- alpha.pch[-index.not]

# Calulate % of PC
PCs.n <- wrap.PCA.r.n$pc.summary$importance
PCx.per.n <- round(PCs.n[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab.n <- paste("PC1", " (", PCx.per.n, "%)", sep = "")
PCy.per.n <- round(PCs.n[2, 2] * 100, digits = 1)
PCy.lab.n <- paste("PC2", " (", PCy.per.n, "%)", sep = "")
```

### Set up 3 datasets for screeplots
```{r}
# Full shape
full.PC.impt <- data.frame(PC = 1:length(PCA.mean.allo$pc.summary$importance[2, ]), impt = PCA.mean.allo$pc.summary$importance[2, ])

# Residual shape
res.PC.impt <- data.frame(PC = 1:length(res.PCA$pc.summary$importance[2, ]), impt = res.PCA$pc.summary$importance[2, ])

# Residual shape without Notomys
rnot.PC.impt <- data.frame(PC = 1:length(wrap.PCA.r.n$pc.summary$importance[2, ]), impt = wrap.PCA.r.n$pc.summary$importance[2, ])
```

### Export skree plots for PC importance scores for 3 separate datasets
```{r}
# Make simple multipanel figure
pdf("../Data/Results/SFigure_Screeplots.pdf")
mat <- matrix(c(1:3), 3, 1, byrow = TRUE)  # 3 plots, 3 rows, 1 column
layout(mat, widths = rep(1, dim(mat)[2]), heights = rep(0.5, dim(mat)[1])) 

# 1) 
barplot(full.PC.impt[, 2], ylab = "% of variance")
abline(h = 0.1, col = 'deeppink4')
legend("topleft", inset = c(0.07, -0.07), legend = "A) full shape dataset", bty = "n", cex = 1.2)

# 2)
barplot(res.PC.impt[, 2], ylab = "% of variance")
abline(h = 0.1, col = 'deeppink4')
legend("topleft", inset = c(0.07, -0.07), legend = "B) residual shape dataset", bty = "n", cex = 1.2)

# 3)
barplot(rnot.PC.impt[, 2], xlab = "Principal component" , ylab = "% of variance")
abline(h = 0.1, col = 'deeppink4')
legend("topleft", inset = c(0.07, -0.07), legend = expression(paste("C) residual shape dataset without ", italic(Notomys))), bty = "n", cex = 1.2)

dev.off()
```


## Export Figure 1
Compare the PCAs relevant to Figure 2 heatmaps
```{r}
# Set up for export and for multiple panels
part.coords <- c(-0.105, 0.145)  # formatting parameters for B, C, D locations
pdf("../Data/Results/Figure1_PCAs.pdf")
mat <- matrix(c(1:4), 2, 2, byrow = TRUE)  # 4 plots, 2 rows, 2 columns
layout(mat, widths = rep(1, dim(mat)[2]), heights = rep(0.5, dim(mat)[1]))   

# A) Plot of allometry PCA - genus colors
par(mar = c(4.5, 4.5, 2, 1))
plot(x = -mean.PCA$pc.scores[, 1],  # Flip for consistency
                 y = mean.PCA$pc.scores[, 2],  
                 xlab = PCx.lab.allo, 
                 ylab = PCy.lab.allo,
                 asp = TRUE,
                 xlim = c(-0.08, 0.12),
                 ylim = c(-0.1, 0.1),
                 col = alpha.col,
                 pch = alpha.pch,
                 bg = alpha.col,
                 cex = 1.5,
                 cex.axis = 1.1, 
                 cex.lab = 1.3)
text(-0.083, 0.097, "A", cex = 1.5)
text(-0.005, 0.0965, "full shape with allometry")
text(-0.022, 0.082, expression(paste("(Marcy ", italic("et al. in review"), ")")), cex = 0.8)

# B) Plot of shape residuals PCA - genus colors
par(mar = c(4.5, 4.5, 2, 1))
plot(x = -res.PCA$pc.scores[, 1],  # Flip for consistency
                 y = -res.PCA$pc.scores[, 2],  
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 asp = TRUE,
                 xlim = c(-0.1, 0.2),
                 ylim = c(-0.15, 0.15),
                 col = alpha.col,
                 pch = alpha.pch,
                 bg = alpha.col,
                 cex = 1.5,
                 cex.axis = 1.1, 
                 cex.lab = 1.3)
legend("bottomright", legend = genera.phylo, col = col.phylo, pch = 16, pt.bg = col.unique.spp, cex = 0.85, bty = "n", text(font = 3))
text(part.coords[1], part.coords[2], "B", cex = 1.5)
text(0.0375, part.coords[2], "shape residuals (genus colors)")

# C) Plot of shape reisiduals PCA without Notomys - genus colors
par(mar = c(4.5, 4.5, 2, 1))
plot(x = -res.PCA$pc.scores[, 1],  # Flip for consistency
                 y = -res.PCA$pc.scores[, 2],  
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 asp = TRUE,
                 xlim = c(-0.1, 0.2),
                 ylim = c(-0.15, 0.15),
                 col = col.diet.means, 
                 pch = pch.gld.means, 
                 bg = col.diet.means,
                 cex = 1.5,
                 cex.axis = 1.1, 
                 cex.lab = 1.3)
legend("topright", legend = c("Aquatic", "Arboreal", "Terrestrial", "Hopping", "", "Carnivore", "Frugivore", "Granivore", "Herbivore", "Omnivore"), col = c(rep("black", 4), "white", col.diet.5), border = NULL, pch = c(21, 24, 22, 23, rep(15, 6)), cex = 0.76, bty = "n", inset = c(0, 0.14))
text(part.coords[1], part.coords[2], "C", cex = 1.5)
text(0.065, part.coords[2], "shape residuals (diet and locomotion)")

# D) Plot of Shape Residuals PCA - diet colors
par(mar = c(4.5, 4.5, 2, 1))
plot(x = wrap.PCA.r.n$pc.scores[, 1],  
                 y = -wrap.PCA.r.n$pc.scores[, 2],  # Flip for consistency
                 xlab = PCx.lab.n, 
                 ylab = PCy.lab.n,
                 asp = TRUE,
                 xlim = c(-0.1, 0.2),
                 ylim = c(-0.15, 0.15),
                 col = alpha.col.no, 
                 pch = alpha.pch.no, 
                 bg = alpha.col.no,
                 cex = 1.5,
                 cex.axis = 1.1, 
                 cex.lab = 1.3)
text(part.coords[1], part.coords[2], "D", cex = 1.5)
text(0.047, part.coords[2], expression(paste("shape residuals without ", italic("Notomys"))))

dev.off()
```

### Save intermediate data
```{r}
save(res.PCA, allom.resid, residuals, file = "../Data/Processed/05-residual-data.rda")
```