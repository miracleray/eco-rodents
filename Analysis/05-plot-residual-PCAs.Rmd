---
title: "05-plot_residual_PCAs"
author: "Ariel Marcy & Vera Weisbecker"
date: "8/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../eco-rodents')
```

# Plot residual PCAs / Test for biome partitioning 
First, test for a phylogenetic signal difference in each of the 7 regions. 

Second, plot without-allometry PCA for all residuals.

Third, plot residuals by region -- a test for partitioning.

### Load packages, functions, and data
Tree, mean shape, and metadata for phylogenetic analyses come from the allometry rodents script 04. 
```{r message = FALSE}
library(geomorph)
library(dplyr)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")
load(file = "../Data/Processed/03-graphing-vectors.rda")
```

### Extract residuals
First, extract residuals - code thanks to Dr Vera Weisbecker
```{r}
# Use pgls of coords with size to get residuals
allom.GDF <- geomorph.data.frame(coords = mean.shapes, Csize = info.means$MeanCsize) 

dimnames(mean.shapes)[[3]] <- info.means$FullName

allometry.all <- procD.pgls(coords ~ Csize, aus.tree, data = allom.GDF)
summary(allometry.all)

# Turn the residuals into an appropriate array
allom.resid <- arrayspecs(allometry.all$pgls.residuals, dim(mean.shapes)[[1]], 3)

# Add the consensus shape (from the GPA) to the residuals if you want to understand the landmark variation in the residuals - needed for script 06
Allom.all.plus.consensus <- allom.resid + array(mean.shapes, dim(allom.resid))
```

### Plot but with only residuals no consensus added
```{r}
res.PCA <- plotTangentSpace(allom.resid, groups = alpha.col)
PlotPCA(res.PCA, 1, 2, alpha.col, alpha.pch, flip.axis2 = TRUE)
legend("bottomright", phylo.names, col = col.unique.spp, pch = pch.unique.spp, pt.bg = col.unique.spp, cex = .53, pt.cex = .7, ncol = 2)
```


## 2) Plot residuals with consensus (WITHOUT allometry) - IMPORTANT FIGURE
Color and legend by species
```{r}
alpha.names <- dimnames(mean.shapes)[[3]]
alpha.col <- col.unique.spp[order(phylo.names)]
alpha.pch <- pch.unique.spp[order(phylo.names)]

res.PCA <- plotTangentSpace(Allom.all.plus.consensus, groups = alpha.col, label = alpha.names)

# Make axis labels
PCs <- res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1", " (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2", " (", PCy.per, "%)", sep = "")
        
# Pretty plot
PCA.plot <- plot(x = -res.PCA$pc.scores[, 1],  # Flip for consistency
                 y = -res.PCA$pc.scores[, 2],  
                 xlab = PCx.lab, 
                 ylab = PCy.lab,
                 asp = TRUE,
                 xlim = c(-0.12, 0.18),
                 ylim = c(-0.18, 0.12),
                 col = alpha.col, 
                 pch = alpha.pch, 
                 bg = alpha.col,
                 cex = 1.5,
                 cex.axis = 1.3, 
                 cex.lab = 1.3)
legend("bottomright", phylo.names, col = col.unique.spp, pch = pch.unique.spp, pt.bg = col.unique.spp, cex = .57, pt.cex = .7, ncol = 2)
```

## 3) Finally, plot the residuals with consensus by region
```{r}
# Set up loop for particular regions in Australia
region.names <- c("Savannah", "Arid Zone", "NE Wet Forest", "NE Dry Forest", "Pilbara", "South West", "South East")
res.pc.scores <- subset(res.PCA$pc.scores, select = 1:3)  # only 1st 3 PCs

# Write x and y labels with proportion of variance for PCx and PCy
PCs <- res.PCA$pc.summary$importance
PCx.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PCx.lab <- paste("PC1 (", PCx.per, "%)", sep = "")
PCy.per <- round(PCs[2, 2] * 100, digits = 1)
PCy.lab <- paste("PC2 (", PCy.per, "%)", sep = "")

par(mfrow = c(4, 2), mar = c(2, 2, 2, 2))
# Loop through all 7 regions to plot morphospace of species found in each
for (i in 1:7) {
        # Subset info.traits and PCA by region
        spp.in.region <- FoundInRegion(traits, regions = i)
        spp.region <- traits[spp.in.region, ]
        
        # Subset metadata by region
        temp <- info.means[, c("Taxa", "MeanCsize", "FullName", "Order")]
        meta.region <- unique(merge(spp.region, temp, by = "FullName"))
        
        # Subset PCA coordinates by region
        res.pc.region <- as.data.frame(res.pc.scores[meta.region$Order, ])
        
        # Subset plotting colors and pch symbols for spp in region
        col.taxa.region <- alpha.col[meta.region$Order]  # colors for all spp
        pch.taxa.region <- alpha.pch[meta.region$Order]  # pch for all spp
        
        # Plot PCA with legend and labels
        PCA.plot <- plot(x = res.pc.region$PC1,
                         y = res.pc.region$PC2,
                         main = paste(region.names[i], "Residual Morphospace" ),
                         xlab = PCx.lab,
                         ylab = PCy.lab,
                         xlim = c(-0.12, 0.15),
                         ylim = c(-0.1, 0.2),
                         col = col.taxa.region, 
                         pch = pch.taxa.region, 
                         bg = col.taxa.region,
                         cex = 1.5,
                         cex.axis = 1.3, 
                         cex.lab = 1.3)
}
```

### Save intermediate data
```{r}
residuals <- Allom.all.plus.consensus  # shape data
save(alpha.col, alpha.pch, res.PCA, allom.resid, residuals, file = "../Data/Processed/05-residual-data.rda")
```